{% extends 'admin/model/list.html' %}

{% block body %}
    <div class="container-fluid">
        <div class="card p-3 mb-3 bg-light border-0 shadow-sm">
            <div class="row align-items-center">
                <div class="col-auto">
                    <label class="fw-bold text-primary"><i class="fas fa-filter"></i> Lọc theo lớp:</label>
                </div>
                <div class="col-md-4">
                    <select class="form-control form-select" onchange="window.location.href='?class_id=' + this.value">
                        <option value="">-- Tất cả các lớp --</option>
                        {% for c in available_classes %}
                        <option value="{{ c.id }}" {% if selected_class_id == c.id|string %}selected{% endif %}>
                            {{ c.name }} ({{ c.course.name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if selected_class_id %}
                <div class="col-auto">
                    <a href="/admin/grade" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sync"></i> Xóa lọc
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        {{ super() }}
    </div>

    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputs = document.querySelectorAll(".score-input");

        inputs.forEach(input => {
            // Sự kiện: Khi rời chuột khỏi ô nhập (Blur)
            input.addEventListener("blur", function() {
                const id = this.getAttribute("data-id");
                const field = this.getAttribute("data-field");
                const value = this.value;

                // Hiệu ứng đang lưu (mờ đi)
                this.style.opacity = "0.5";

                fetch('/admin/grade/ajax_update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id, field: field, value: value })
                })
                .then(res => res.json())
                .then(data => {
                    this.style.opacity = "1";

                    if(data.status === 'success') {
                        showToast("Đã lưu điểm thành công!", "success");
                        this.style.backgroundColor = "#d4edda"; // Màu xanh nhạt

                        // Cập nhật cột Kết Quả (Đạt/Không Đạt) ngay lập tức
                        const resSpan = document.getElementById('result-' + id);
                        if (resSpan) {
                            resSpan.innerText = data.new_result;

                            if (data.new_result === 'Đạt') {
                                resSpan.className = 'fw-bold text-success';
                            } else {
                                resSpan.className = 'fw-bold text-danger';
                            }
                        }
                    } else {
                        // Báo lỗi (VD: Nhập quá 10 điểm, hoặc lớp đã kết thúc)
                        showToast(data.msg, "danger");
                        this.style.backgroundColor = "#f8d7da"; // Màu đỏ nhạt
                    }
                })
                .catch(err => {
                    this.style.opacity = "1";
                    showToast("Lỗi kết nối server", "danger");
                });
            });

            // Sự kiện: Bấm Enter cũng lưu
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") { e.preventDefault(); this.blur(); }
            });
        });

        // Hàm hiện thông báo góc màn hình
        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `alert alert-${type} shadow-sm`;
            t.innerText = msg;
            t.style.minWidth = "200px";
            t.style.marginBottom = "10px";

            const container = document.getElementById('toast-container');
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    });
    </script>
{% endblock %}