{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid mt-4">
    <h2 class="text-primary text-center text-uppercase fw-bold mb-4">
        <i class="fas fa-edit"></i> BẢNG ĐIỂM CHI TIẾT
    </h2>

    <div class="card p-3 mb-4 bg-white shadow-sm border-0 rounded-3">
        <div class="row align-items-center">
            <div class="col-auto">
                <label class="fw-bold text-muted"><i class="fas fa-filter"></i> Lọc theo lớp:</label>
            </div>
            <div class="col-md-4">
                <select class="form-control form-select shadow-none border-secondary" onchange="window.location.href='?class_id=' + this.value">
                    <option value="">-- Vui lòng chọn lớp --</option>
                    {% for c in classes %}
                    <option value="{{c.id}}" {% if chosen_class and chosen_class.id == c.id %}selected{% endif %}>
                        {{c.name}} ({{c.course.name}})
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% if chosen_class %}
            <div class="col-auto ms-auto">
                <a href="/admin/gradecolumn/?class_id={{chosen_class.id}}" class="btn btn-outline-primary rounded-pill px-3">
                    <i class="fas fa-plus-circle"></i> Thêm Cột Điểm
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    {% if chosen_class %}
    <div class="card shadow border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="bg-primary text-white text-center">
                        <tr>
                            <th style="width: 50px">STT</th>
                            <th>Mã HV</th>
                            <th>Họ và Tên</th>

                            {% for col in columns %}
                            <th style="min-width: 100px;">
                                {{ col.name }} <br> <small class="text-warning">({{ col.weight }}%)</small>
                            </th>
                            {% endfor %}

                            <th style="width: 80px" class="bg-warning text-dark">TB</th>
                            <th style="width: 100px" class="bg-warning text-dark">KQ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            <td class="text-center">{{ loop.index }}</td>
                            <td class="text-center"><span class="badge bg-light text-dark border">{{ row.student_code }}</span></td>
                            <td class="fw-bold">{{ row.student_name }}</td>

                            {% for col in columns %}
                            <td class="text-center p-0 position-relative">
                                <input type="number" step="0.1" min="0" max="10"
                                       class="form-control text-center score-input fw-bold h-100 w-100 border-0"
                                       style="background: transparent;"
                                       data-grade-id="{{ row.grade_id }}"
                                       data-col-id="{{ col.id }}"
                                       value="{{ row.scores.get(col.id, '') }}"
                                       placeholder="-">
                            </td>
                            {% endfor %}

                            <td class="text-center fw-bold text-primary" id="avg-{{ row.grade_id }}">
                                {{ row.final }}
                            </td>
                            <td class="text-center fw-bold" id="res-{{ row.grade_id }}">
                                <span class="badge {{ 'bg-success' if row.result == 'Đạt' else 'bg-danger' }}">
                                    {{ row.result }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const inputs = document.querySelectorAll(".score-input");

    inputs.forEach(input => {
        input.addEventListener("blur", function() { saveScore(this); });

        input.addEventListener("keypress", function(e) {
            if (e.key === "Enter") { e.preventDefault(); this.blur(); }
        });

        input.addEventListener("focus", function() {
            this.style.backgroundColor = "#e8f0fe";
        });
        input.addEventListener("focusout", function() {
            if(this.value === "") this.style.backgroundColor = "transparent";
        });
    });

    function saveScore(el) {
        const gradeId = el.getAttribute("data-grade-id");
        const colId = el.getAttribute("data-col-id");
        let val = el.value;

        if (val === "") { el.style.backgroundColor = "transparent"; return; }

        let numVal = parseFloat(val);
        if (numVal < 0 || numVal > 10) {
            alert("Lỗi: Điểm phải từ 0 đến 10!");
            el.value = "";
            el.style.backgroundColor = "#f8d7da"; // Báo đỏ
            el.focus();
            return;
        }

        el.style.color = "#999";

        fetch('/admin/grade_manager/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ grade_id: gradeId, column_id: colId, value: numVal })
        })
        .then(res => res.json())
        .then(data => {
            el.style.color = "black";
            el.style.backgroundColor = "transparent";

            if(data.status === 'success') {
                const parentTd = el.parentElement;
                parentTd.style.backgroundColor = "#d4edda";
                setTimeout(() => parentTd.style.backgroundColor = "transparent", 800);

                document.getElementById('avg-' + gradeId).innerText = data.new_avg;
                const resSpan = document.getElementById('res-' + gradeId);

                if (data.new_res == 'Đạt') {
                    resSpan.innerHTML = '<span class="badge bg-success">Đạt</span>';
                } else {
                    resSpan.innerHTML = '<span class="badge bg-danger">Không đạt</span>';
                }
            } else {
                alert("Lỗi Server: " + data.msg);
                el.style.backgroundColor = "#f8d7da";
            }
        });
    }
});
</script>
{% endblock %}