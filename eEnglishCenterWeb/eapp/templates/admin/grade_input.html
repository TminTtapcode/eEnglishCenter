{% extends 'admin/master.html' %}

{% block body %}
<div class="container mt-4">
    <h2 class="text-primary text-center">NHẬP ĐIỂM CHI TIẾT</h2>

    <div class="card p-4 mb-4 bg-light shadow-sm">
        <form method="GET" action="/admin/input_score/">
            <div class="row">
                <div class="col-md-5">
                    <label class="fw-bold">1. Chọn Lớp:</label>
                    <select name="class_id" class="form-control" onchange="this.form.submit()">
                        <option value="">-- Chọn lớp --</option>
                        {% for c in classes %}
                        <option value="{{c.id}}" {% if chosen_class and chosen_class.id == c.id %}selected{% endif %}>
                            {{c.name}}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                {% if chosen_class %}
                <div class="col-md-5">
                    <label class="fw-bold">2. Chọn Cột Điểm:</label>
                    <select name="column_id" class="form-control" onchange="this.form.submit()">
                        <option value="">-- Chọn đầu điểm cần nhập --</option>
                        {% for col in columns %}
                        <option value="{{col.id}}" {% if chosen_column and chosen_column.id == col.id %}selected{% endif %}>
                            {{col.name}} ({{col.weight}}%)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <a href="/admin/gradecolumn/new/?url=/admin/input_score/?class_id={{chosen_class.id}}" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Thêm Cột
                    </a>
                </div>
                {% endif %}
            </div>
        </form>
    </div>

    {% if chosen_column %}
    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h5 class="m-0">Nhập điểm: <strong>{{ chosen_column.name }}</strong> ({{ chosen_column.weight }}%)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px">STT</th>
                            <th>Mã HV</th>
                            <th>Họ Tên</th>
                            <th style="width: 200px">Điểm Số</th>
                            <th>Trạng Thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in students %}
                        <tr>
                            <td class="text-center">{{ loop.index }}</td>
                            <td>{{ s.student_code }}</td>
                            <td class="fw-bold">{{ s.student_name }}</td>
                            <td>
                                <input type="number" step="0.1" min="0" max="10"
                                       class="form-control text-center fw-bold score-input"
                                       data-grade-id="{{ s.grade_id }}"
                                       value="{{ s.score_value }}">
                            </td>
                            <td class="text-center">
                                <span id="status-{{ s.grade_id }}" class="badge bg-secondary">Chờ lưu...</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const inputs = document.querySelectorAll(".score-input");
    const columnId = "{{ chosen_column.id if chosen_column else '' }}";

    inputs.forEach(input => {
        input.addEventListener("blur", function() {
            const gradeId = this.getAttribute("data-grade-id");
            const value = this.value;
            const statusBadge = document.getElementById('status-' + gradeId);

            statusBadge.className = 'badge bg-warning text-dark';
            statusBadge.innerText = 'Đang lưu...';

            fetch('/admin/input_score/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    grade_id: gradeId,
                    column_id: columnId,
                    value: value
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.innerText = 'Đã lưu';
                } else {
                    alert('Lỗi: ' + data.msg);
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.innerText = 'Lỗi';
                }
            });
        });

        input.addEventListener("keypress", function(e) {
            if (e.key === "Enter") { e.preventDefault(); this.blur(); }
        });
    });
});
</script>
{% endblock %}